<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
  <h1>By Wasm OpenCV</h1>

  <canvas id="canvas" width="32" height="40"></canvas>
  
  <script>
const init = async () => {
function passToWasm(uint8ArrData, width, height) {
    // copying the uint8ArrData to the heap
    const numBytes = uint8ArrData.length * uint8ArrData.BYTES_PER_ELEMENT;
    const dataPtr = Module._malloc(numBytes);
    const dataOnHeap = new Uint8Array(Module.HEAPU8.buffer, dataPtr, numBytes);
    dataOnHeap.set(uint8ArrData);
    // calling the Wasm function
    console.log(dataOnHeap.byteOffset);
    const res = Module.image_input(dataOnHeap.byteOffset, uint8ArrData.length, width, height);
    console.log(res);
    Module._free(dataPtr);
}

function sendCanvas(canvas, baseImage) {
    const context = canvas.getContext('2d');
    context.drawImage(baseImage, 0, 0, baseImage.width, baseImage.height);
    const { width } = canvas;
    const { height } = canvas;
    const imgData = context.getImageData(0, 0, canvas.width, canvas.height);
    const uint8ArrData = new Uint8Array(imgData.data);

     // pass the width and height too !!
    passToWasm(uint8ArrData, imgData.width, imgData.height);
}

const baseImage = new Image();
//baseImage.src = 'hand.jpg';
baseImage.src = 'red_white.png';
baseImage.onload = () => sendCanvas(canvas, baseImage);
};
window.Module = {
  canvas: document.getElementById("canvas"),
  onRuntimeInitialized: init,
  print: function(text) { console.log(text); },
  //print: function(text){},
  printErr: function(text) { console.log(text); }
  //canvas: (function() { return document.getElementById('canvas'); })()
};

  </script>
  <script src="main.js"></script>
</body>

</html>
